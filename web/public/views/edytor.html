<!DOCTYPE html>
<html>
<head>
    <title>Monaco Editor with Echo</title>
    <script src="/assets/monaco/vs/loader.js"></script>
    {{template "styles" .}}
</head>
<body>

<div class="col">
    <div class="row">
        <div class="input-group mb-3">
            <input type="text" class="form-control" placeholder="Recipient's username" aria-label="Recipient's username"
                   aria-describedby="button-addon2">
            <button class="btn btn-outline-secondary" type="button" id="button-addon2">Button</button>
        </div>
    </div>
    <div class="row">
        <div class="col-6">
            <div id="container" style="height:600px;"></div>
        </div>
        <div class="col-6">
<pre id="mermaid">

    </pre>

        </div>
    </div>
</div>
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

    mermaid.initialize({startOnLoad: false});
    window.drawDiagram = async function () {
        let element = document.querySelector('#mermaid');
        const graphDefinition = 'graph TB\na-->b';
        const {svg} = await mermaid.render('graphDiv', graphDefinition);
        element.innerHTML = svg;
    };

</script>
<script>
    const initialPipeline = '{{.InitCommand}}'

    require.config({paths: {'vs': '/assets/monaco/vs'}});

    require(['vs/editor/editor.main'], function () {
        monaco.languages.registerCompletionItemProvider('json', {
            provideCompletionItems: function (model, position) {
                const word = model.getWordUntilPosition(position);
                const range = {
                    startLineNumber: position.lineNumber,
                    endLineNumber: position.lineNumber,
                    startColumn: word.startColumn,
                    endColumn: word.endColumn
                };

                const suggestions = [];

                {{range $action, $json := .Actions}}
                suggestions.push(
                    {
                        label: '{{$action}}',
                        kind: monaco.languages.CompletionItemKind.Keyword,
                        insertText: '{{$json}}',
                        range: range
                    }
                )
                {{end}}

                return {suggestions: suggestions};
            }
        });

        let editor = monaco.editor.create(document.getElementById('container'), {
            value: initialPipeline,
            language: 'json'
        });

        (async () => {
            await drawDiagram();
        })();

        editor.onDidChangeModelContent(function (e) {
            (async () => {
                await drawDiagram();
            })();
            let code = editor.getValue();
            let js = JSON.parse(code)
            console.log(js.Tasks)
        });

    });
</script>
{{template "scripts" .}}
</body>
</html>
